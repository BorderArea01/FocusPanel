<Window x:Class="FocusPanel.Views.TaskDetailWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:vm="clr-namespace:FocusPanel.ViewModels"
        mc:Ignorable="d"
        d:DataContext="{d:DesignInstance Type=vm:TasksViewModel}"
        Title="Task Detail" Height="800" Width="600"
        WindowStartupLocation="CenterScreen"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        ResizeMode="CanResizeWithGrip">
    
    <Border Background="{DynamicResource MaterialDesignPaper}" 
            CornerRadius="8" 
            Padding="0"
            BorderThickness="1" 
            BorderBrush="{DynamicResource MaterialDesignDivider}">
        <Border.Effect>
            <DropShadowEffect BlurRadius="20" ShadowDepth="5" Opacity="0.3"/>
        </Border.Effect>
        
        <DockPanel>
            <!-- Header -->
            <Grid DockPanel.Dock="Top" Margin="12,12,12,0" MouseDown="Header_MouseDown">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Actions -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Top">
                    <Button Style="{StaticResource MaterialDesignIconForegroundButton}"
                            Command="{Binding DataContext.NavigateToItemCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                            CommandParameter="{Binding SelectedTask}"
                            ToolTip="Open List"
                            Width="32" Height="32"
                            Margin="0,0,4,0">
                        <materialDesign:PackIcon Kind="OpenInNew" Width="18" Height="18"/>
                    </Button>

                    <Button Style="{StaticResource MaterialDesignIconForegroundButton}"
                            Command="{Binding CloseTaskDetailCommand}"
                            ToolTip="Close Details"
                            Width="32" Height="32">
                        <materialDesign:PackIcon Kind="Close" Width="20" Height="20"/>
                    </Button>
                </StackPanel>
            </Grid>
            
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="32,16,32,24">
                    <!-- Title (Large) -->
                    <TextBox Text="{Binding SelectedTask.Title}" 
                             Style="{StaticResource MaterialDesignTextBox}"
                             FontSize="24"
                             FontWeight="Regular"
                             Margin="0,0,0,32"
                             TextWrapping="Wrap"
                             materialDesign:HintAssist.Hint="Task Title"
                             BorderThickness="0"/>
                    
                    <!-- Custom Fields -->
                    <ItemsControl ItemsSource="{Binding CurrentTaskCustomFields}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="0,0,0,24">
                                    <TextBlock Text="{Binding Definition.Name}" 
                                               Style="{StaticResource MaterialDesignCaptionTextBlock}" 
                                               Foreground="{DynamicResource PrimaryHueMidBrush}"
                                               Margin="0,0,0,8"/>
                                    
                                    <!-- Short Text -->
                                    <TextBox Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}" 
                                             Visibility="{Binding IsShortText, Converter={StaticResource BooleanToVisibilityConverter}}"
                                             Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                             Padding="8"/>
                                    
                                    <!-- Multi/Single Select -->
                                    <ComboBox ItemsSource="{Binding Options}" 
                                              SelectedItem="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                                              Visibility="{Binding IsSingleSelect, Converter={StaticResource BooleanToVisibilityConverter}}"
                                              materialDesign:HintAssist.Hint="Select option"
                                              Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                              Padding="8"/>
                                    
                                    <ItemsControl ItemsSource="{Binding MultiSelectOptions}"
                                                  Visibility="{Binding IsMultiSelect, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <CheckBox IsChecked="{Binding IsSelected}" Content="{Binding Name}" Margin="0,4"/>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                    
                                    <!-- Long Text (Markdown) -->
                                    <StackPanel Visibility="{Binding IsLongText, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <Grid Margin="0,0,0,8">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="Markdown" Opacity="0.5" VerticalAlignment="Center" FontSize="12"/>
                                            <Button Grid.Column="1" Style="{StaticResource MaterialDesignFlatButton}"
                                                    Command="{Binding DataContext.InsertImageToMarkdownCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding}"
                                                    Content="Insert Image"
                                                    Height="24" FontSize="10" Padding="8,0"/>
                                        </Grid>
                                        
                                        <TextBox Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}" 
                                                 AcceptsReturn="True"
                                                 TextWrapping="Wrap"
                                                 VerticalScrollBarVisibility="Auto"
                                                 MinHeight="120" MaxHeight="300"
                                                 Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                                 Padding="8"/>
                                        
                                        <!-- Image Thumbnails -->
                                        <ItemsControl ItemsSource="{Binding ExtractedImages}" Margin="0,8,0,0">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel Orientation="Horizontal"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Button Command="{Binding DataContext.OpenImageCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                            CommandParameter="{Binding}"
                                                            Width="80" Height="80"
                                                            Margin="0,0,8,8"
                                                            Padding="0"
                                                            ToolTip="Open Image"
                                                            Style="{StaticResource MaterialDesignFlatButton}">
                                                        <Image Source="{Binding}" Stretch="UniformToFill"/>
                                                    </Button>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </ScrollViewer>
        </DockPanel>
    </Border>
</Window>